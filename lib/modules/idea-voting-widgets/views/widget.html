{% import 'includes/ideas-lister.html' as ideasList %}
{% import 'includes/vote-creator.html' as voteCreator %}

{{ voteCreator.showVoteCreator(true, data.ideas) }}
<script>
 csrfToken = '{{csrfToken}}';
</script>

<script>
 var endDate = new Date('2018-09-02');
 var endDateText = '2 september 2018';
 var daysLeft = parseInt( ( endDate.getTime() - Date.now() ) / ( 24 * 60 * 60 * 1000) ) + 1;
</script>

<div class="pageContent {{contentClass}}">

	<div id="end-date-bar">
		<div id="ideas-anchor"></div>
		<span id="end-date-bar-start-text" class="text"></span>
		<span id="number-plates">
			<span id="end-date-number-plate-00" class="number-plate"> 0 </span><span id="end-date-number-plate-0" class="number-plate"> 0 </span>
		</span>
		<span id="end-date-bar-end-text" class="text"></span>
	</div>
	<script>
	 if ( daysLeft > 0 ) {
		 document.getElementById('end-date-bar-start-text').innerHTML = 'Stemmen kan t/m ' + endDateText + ': ';
		 document.getElementById('end-date-bar-end-text').innerHTML = 'dagen';
		 var value000 = parseInt(daysLeft/100) || 0;
		 var value00  = parseInt(daysLeft/10) - value000;
		 var value0   = daysLeft - value000 * 100 - value00 * 10;
		 document.getElementById('end-date-number-plate-00').innerHTML = value00;
		 document.getElementById('end-date-number-plate-0').innerHTML = value0;
	 } else {
		 document.getElementById('end-date-bar-start-text').innerHTML = 'Stemmen kon t/m ' + endDateText;
		 document.getElementById('end-date-number-plate-00').innerHTML = 0;
		 document.getElementById('end-date-number-plate-0').innerHTML = 0;
	 }
	</script>

	<div id="ideas" class="primary">
		<h1>
			Ingestuurde ontwerpen ({{data.ideas.length}})
			<select id="selectSort">
				<option value="random">Sorteer</option>
				<option {{'selected' if sort == 'ranking'}} value="ranking">Meeste stemmen</option>
				<option {{'selected' if sort == 'rankinginverse'}} value="rankinginverse">Minste stemmen</option>
			</select>
		</h1>

		{{ ideasList.showIdeasList(data.ideas, data.widget.userHasVoted, data.widget.isAdmin) }}

	</div>

</div>


<script>

 // Sorting dropdown
 // ----------------
 (function() {
	 var select = document.querySelector('#selectSort');
   if (select) {
  	 select.addEventListener('change', function() {
  		 // Replace current `sort=x` with new choice.
  			 var pathName = location.pathname;
  		 var search   = location.search.replace(/sort=[a-z_]*/i, '') || '?';
  		 if (search.match(/[^?&]$/)) {
  			 search += '&';
  		 }
  		 location.href = pathName + search + 'sort=' + select.value + '#ideas';
  	 });
   }
 })();
</script>
<script>
 // todo: dit stat nu hier omdat je anders de indeen nog niet hebt, maar zou natuurlijk in de widget moeten
 function openstadGetCookie(name) {
   var match = document.cookie.match(new RegExp("(?:^|;\\s*)\\s*" + name +"=([^;]+)\\s*(?:;|$)"));

   var value;
   if (match) {
     value = match[1];
   }

   try {
     value = JSON.parse(value);
   } catch(err) {}

   return value;

 }

 function openstadSetCookie(name, value, days, path) {

   if ( typeof name != 'string' ) return;

   if ( typeof value == 'undefined' ) value = "";
   if ( typeof value == 'object' ) {
     try {
       value = JSON.stringify(value);
     } catch(err) {}
   };


   var expires = "";
   if (days) {
     var date = new Date();
     date.setTime(date.getTime() + (days*24*60*60*1000));
     expires = "expires=" + date.toUTCString();
   }

   path = path ? "path= " + path : ""

   document.cookie = name + "=" + value + "; " + expires + "; " + path;

 }




 var stepNo       = '{{stepNo}}'           || openstadGetCookie('stepNo')		    || '';
 var ideaId		    = '{{userVoteIdeaId}}'   || openstadGetCookie('ideaId')		    || '';
 var zipCode	    = '{{user.zipCode}}'     || openstadGetCookie('zipCode')	    || '';
 var email		    = '{{user.email}}'	     || openstadGetCookie('email')		    || '';
 var hasVoted     = '{{userHasVoted}}'     || openstadGetCookie('hasVoted')     || '';
 var hasConfirmed = '{{userHasConfirmed}}' || openstadGetCookie('hasConfirmed') || '';


 var match = window.location.hash.match(/ideaId-(\d+)/);
 var showIdeaId = match ? match[1] : undefined;

 // tmp
 // var match = window.location.search.match(/stepNo=(\d+)/);
 // if (match) {
 //  	 currentStep = parseInt( match[1] );
 //  	 hideStep(steps[0]);
 //  	 showStep(steps[currentStep])
 // }

 // var match = window.location.search.match(/zipCode=([a-zA-Z0-9]{6})/);
 // if (match) {
 //  	 zipCode = match[1];
 // }
 document.querySelector('input[name=zipCode]').value = zipCode;

 // var match = window.location.search.match(/email=([^&]+)/);
 // if (match) {
 //  	 email = match[1];
 // }
 document.querySelector('input[name=email]').value = email;

 // var match = window.location.search.match(/ideaId=(\d+)/);
 // if (match) {
 //  	 ideaId = match[1];
 // }
 // document.querySelector('input[name=ideaId]').value = ideaId;

 var match = window.location.hash.match(/closed/);
 if (match) {
	 hideVoteCreator();
 } else {

	 if (hasConfirmed) {
		 setHasConfirmed();
	 } else {
		 if (hasVoted) {
			 setHasVoted();
		 }
	 }

	 var match = window.location.hash.match(/vote-creator-anchor/);
	 if (match) {
		 showVoteCreator();
	 }

	 if (ideaId) {
		 showVoteCreator()
		 selectIdea(ideaId, true);
	 }

	 setNextButton();

 }

 window.onload = function(){
	 var match = window.location.search.match(/ideaId=(\d+)/);
	 if (match) {
		 showIdeaId = match[1];
	 };
	 if (showIdeaId) {
		 document.querySelector('#idea-' + showIdeaId).click()
	 }
 }

</script>
