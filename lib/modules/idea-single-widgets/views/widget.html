{% set idea = data.idea %}

{% import 'includes/numberplatebutton.html' as numberPlateButton %}
{% import 'includes/modbreak.html' as modbreak %}

<div class="pageContent idea">
	<div id="title">
		<div>
			<div class="primary">
				{% if idea.extraData.images[0] %}
					<div class="image" style="background-image: url('{{idea.extraData.images[0]}}');"></div>
				{% elif idea.location %}
					<div class="image" style="background-image: url(
					'https://maps.googleapis.com/maps/api/streetview?size=1400x700&location={{idea.location.coordinates[0]}},{{idea.location.coordinates[1]}}&heading=151.78&key={{apos.settings.getOption('googleMapsApiKey')}}'
					);"></div>
				{% else %}
					<div class="image"></div>
				{% endif %}
				{% if idea.status == 'CLOSED' %}
					<div class="statusbalk {{idea.status}}">De stemperiode is afgelopen</div>
				{% elif idea.status == 'DENIED' %}
					<div class="statusbalk {{idea.status}}">Dit voorstel is afgewezen</div>
				{% else %}
					<div class="statusbalk {{idea.status}}">Je kunt nu op dit plan stemmen</div>
				{% endif %}
				<!--
						 <div class="ranking {{idea.status}}"><div class="label">{{idea.ranking}}</div></div>
				-->
			</div>

			<div class="secondary">
				<div class="controls">
					<h4>Stemmen</h4>

					{% if (idea.status === 'OPEN') %}
						<div class="vote">
							<form method="POST" action="/vote">
								<input type="hidden" name="ideaId" value={{idea.id}} />
								<input type="hidden" name="_csrf" value="{{csrfToken}}">
								{{numberPlateButton.numberPlateButton('no-of-votes-for', '', idea.yes)}}
								<button class="{{'selected' if idea.userVote.opinion == 'yes'}}" type="submit" name="opinion" value="yes" data-count="{{idea.yes}}">
									voor
								</button>
								<div style="clear: both;"></div>
								{{numberPlateButton.numberPlateButton('no-of-votes-against', '', idea.no)}}
								<button class="{{'selected' if idea.userVote.opinion == 'no'}}" type="submit" name="opinion" value="no" data-count="{{idea.no}}">
									tegen
								</button>
								<div style="clear: both;"></div>
							</form>
						</div>
					{% else %}
						<div class="vote disabled">
							{{numberPlateButton.numberPlateButton('no-of-votes-for', '', idea.yes)}}
							<button disabled="true" class="{{'selected' if userVote.opinion == 'yes'}}" type="button" name="opinion" value="yes" data-count="{{idea.yes}}">
								voor
							</button>
							<div style="clear: both;"></div>
							{{numberPlateButton.numberPlateButton('no-of-votes-against', '', idea.no)}}
							<button disabled="true" class="{{'selected' if userVote.opinion == 'no'}}" type="button" name="opinion" value="no" data-count="{{idea.no}}">
								tegen
							</button>
							<div style="clear: both;"></div>
						</div>
					{% endif %}

					<div class="ideaProgress">
						<div class="progress"><div class="bar {{idea.status}}" style="width: {{idea.progress*2}}%;"></div></div>
					</div>

					<div class="ideaDuration {{idea.status}}">
						<h4>Status</h4>
						<div class="duration">
							{% if idea.status == 'CLOSED' %}
								<div>De stemperiode is afgelopen</div>
							{% elif idea.status == 'DENIED' %}
								<div>Stemmen op dit voorstel is niet meer mogelijk.</div>
							{% elif idea.status == 'ACCEPTED' %}
								<div>Dit voorstel wordt besproken in de volgende vergadering!</div>
							{% elif idea.status == 'BUSY' %}
								<div>Dit voorstel wordt uitgevoerd. Lees op deze pagina over de voortgang.</div>
							{% elif idea.status == 'DONE' %}
								<div>Dit voorstel is uitgevoerd. Lees daar meer over op deze pagina.</div>
							{% else %}
								<div id="nog-xxx-om-te-stemmen"></div>
								<script>
									var endDate2 = new Date('{{idea.endDate}}');
									var daysLeft2 = parseInt( ( endDate2.getTime() - Date.now() ) / ( 24 * 60 * 60 * 1000) ) + 1;

								  document.getElementById('nog-xxx-om-te-stemmen').innerHTML = `Nog ${daysLeft2} dagen om te stemmen`;
								</script>
							{% endif %}
						</div>
					</div>

					<div class="share">
						<h4>Deel dit voorstel</h4>
						<ul>
							<li><a class="facebook" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u={{url}}">Facebook</a></li>
							<li><a class="twitter"  target="_blank" href="https://twitter.com/home?status={{url}}">Twitter</a></li>
							<li><a class="email"    target="_blank" href="mailto:?subject={{'Idee voor West: '+idea.title | urlencode}}&body={{url | urlencode}}">Email</a></li>
						</ul>
					</div>

				</div>
			</div>

		</div>
	</div>
</div>
<div class="pageContent idea">
	<div class="primary">
		<h1>{{idea.title}}</h1>

		<div id="author">

				<strong>Door: {{idea.user.firstName}} {{idea.user.lastName}}</strong><br>

			{{idea.startDate | date('LL')}}
		</div>

		{{ modBreak.render(idea) if idea.modBreak and not (idea.status === 'OPEN') }}

		<div class="userContent">
			<p class="summary">
				<strong>{{idea.summary | safe | nlbr}}</strong>
			</p>

			{{idea.description | safe}}
		</div>

		{% if idea.location %}
			<br/><br/>
			<div id="mapcontainer">
				{% include 'includes/openstad-map.html' %}
			</div>
		{% endif %}

		{{ modBreak.render(idea) if idea.modBreak and not (idea.status === 'OPEN') }}
	</div> <!-- #primary -->

	<div class="secondary">
		{# <h2>Volgen</h2>

		<form action="/plan/{{idea.id}}/notify">
		<input type="submit" value="Mail updates">
		</form> #}

		{#
		{% 'includes/crud/edit-delete.html' %}
		{% 'includes/crud/admin.html' %}
		#}

	</div>
</div>

{#
<script src="/js/promise.js"></script>
<script src="/js/fetch.js"></script>
<script>
 // Helper for sending non-GET HTTP requests
 // ----------------------------------------
 // Used in progressive enhancement scripts to replace a 'old-school'
 // request with a `fetch`/`XMLHTTPRequest` action.
 (function( global ) {
	 var csrfToken = '{{csrfToken}}';

	 // Wrapper for fetch to POST/PUT data
	 global.send = function( method, url, data ) {
		 data._csrf = csrfToken;

		 return fetch(url, {
			 method      : method,
			 headers     : {
				 'Content-Type' : 'application/json',
				 'Accept'       : 'application/json'
			 },
			 credentials : 'same-origin',
			 body        : data ? JSON.stringify(data): null
		 })
			 .then(handleResponse)
			 .then(function( data ) {
				 if( 'csrfToken' in data ) {
					 csrfToken = data.csrfToken;
					 // HACK?: Update all tokens in static forms as well.
						 $('form input[type="hidden"][name="_csrf"]').forEach(function( input ) {
							 input.value = csrfToken;
						 });
				 }
				 return data;
			 });
	 }

	 function handleResponse( response ) {
		 var json = response.json();
		 if( response.status >= 200 && response.status < 300 ) {
			 return json;
		 } else {
			 return json.then(function( data ) {throw data});
		 }
	 }
 })(this);
</script>


<script>
 // First image in content
 // ----------------------
 // If the content starts with an image, remove it from the content
 // since it's already visible as poster image.
 var figure = document.querySelector('.userContent figure:first-child');
 if( figure ) {
	 var parent = figure.parentNode;
	 if( parent.firstChild === figure ) {
		 parent.removeChild(figure);
	 }
 }
</script>

<script>
 // Delete idea confirmation
 // ------------------------
 var form = document.getElementById('deleteIdea');
 if( form ) {
	 form.addEventListener('submit', function( event ) {
		 var msg = 'Let op! Je staat op het punt je voorstel te verwijderen. '+
			         'Dit kan niet ongedaan gemaakt worden.\n\n'+
			         'Weet je het zeker?';
		 if( !confirm(msg) ) {
			 event.preventDefault();
		 }
	 });
 }
</script>
#}
