{% set pageTitle = 'Jouw plan insturen' %}
{% set showForm = true %}
{% set summaryMaxLength = 140 %}
{% set summaryMinLength = 20 %}
{% set useModernEditor = false %}
{% set idea = data.idea %}
{% set isOwner = data.openstadUser.id === idea.userId %}
{% set isOwnerOrAdmin =(isOwner or data.isAdmin) %}

{% if idea and isOwnerOrAdmin %}
{% set showForm = true %}
{% elseif (not idea) %}
{% set showForm = true %}
{% else %}
{% set showForm = false %}
{% endif %}

<link rel="stylesheet" type="text/css" href="/trix/dist/trix.css">
<link rel="stylesheet" type="text/css" href="/css/main.css">

{% if not showForm %}
<div class="box-grey">
    <h1> Je hebt geen rechten voor deze pagina </h1>
</div>
{% elseif showForm %}

<form method="post" id="js-form" action="/modules/idea-form-widgets/submit">

    <div class="form-group">
        <div id="imageUpload">
            <h2>
                {{ data.widget.labelImages if data.widget.labelImages else 'Plaatjes' }}
            </h2>
            <div class="form-info">
                {{ data.widget.infoImages if data.widget.infoImages else 'Let op: Stuur alleen een foto mee die je zelf gemaakt hebt! Foto\'s van anderen kunnen auteursrechtelijk beschermd zijn. Je hebt toestemming nodig van de fotograaf om die foto te uploaden.' }}
            </div>
            <fieldset class="filepondFieldset">
                <!-- a list of already uploaded files -->
                <script>
                    var ideaFiles = [];
                    <!-- a list of already uploaded files -->
                    {% if idea.extraData.images %}
                    {% for image in idea.extraData.images %}
                    ideaFiles.push({
                        source: '{"url":"{{image}}"}',
                        options : {
                            type: 'local',
                            // mock file information
                            file: {
                                name: '{{image}}',
                                //		 size: 3001025,
                                //	 type: 'image/png'
                            },
                            metadata: {
                                poster: '{{image}}',
                            }
                        }

                    });
                    {% endfor %}
                    {% endif %}
                </script>
                <input type="file" class="imageUploader filepond" multiple />

            </fieldset>
            <input type="hidden" name="validateImages" multiple />
        </div>
    </div>

    <div id="titleAndSummary">
        <h2>Naam</h2>
        <p>{{data.openstadUser.firstName}} {{data.openstadUser.lastName}} <em>(je emailadres wordt nooit gepubliceerd)</em></p>

        <h2>{{ data.widget.labelTitle if data.widget.labelTitle else 'Titel plan' }}</h2>
        <div class="field_desc">{{ data.widget.infoTitle if data.widget.infoTitle else 'Geef je voorstel een duidelijke titel, zodat anderen jouw inzending makkelijk kunnen vinden en direct snappen waar het over gaat.' }}</div>
        <input type="text" name="title" value=""><br>

        <input type="hidden" id="extraData" name="extraData" value=""><br>

        <h2>Thema</h2>
        <select id="thema" value="">
            <option value="">Kies thema</option>
            <option value="Sport, spelen en ontmoeten">Sport, spelen en ontmoeten</option>
            <option value="Straatbeeld">Straatbeeld</option>
            <option value="Groen en duurzaamheid">Groen en duurzaamheid</option>
        </select>
        <br>

        <h2>Samenvatting</h2>
        Vertel in maximaal 140 tekens iets meer over je plan. Deze tekst wordt voor het publiek zichtbaar op de overzichtspagina van alle plannen.<br>
        <textarea name="summary"></textarea>
        <div id="charsLeft">Je hebt nog <span></span> tekens over.</div>
    </div>

    <div id="description">
        <h2>Beschrijving</h2>
        <div class="form-info">
            Gebruik de ruimte hieronder om je plan verder uit te leggen. Houd er rekening mee dat de lezer van je omschrijving een medebewoner is die misschien wel op jouw idee wil stemmen. Het is dus belangrijk dat diegene ook weet waar hij/ zij precies op stemt. Je blijft zelf eigenaar van het initiatief.
            <ul>
                <li>Wat is het verhaal achter jouw plan?</li>
                <li>Voor wie is het plan?</li>
                <li>Is het een plan dat je zelf wilt uitvoeren, of moet het door een organisatie of de gemeente uitgevoerd worden?</li>
                <li>Wat wil je ermee bereiken?</li>
                <li>Draag argumenten aan om mensen uit Duinoord te overtuigen op jouw plan te stemmen. Je plan heeft minimaal 25 stemmen nodig om door te gaan naar de volgende fase.</li>
            </ul>
        </div>
        <input type="hidden" id="js-description" name="description" value="">

        <trix-toolbar id="trixToolbar">
            <div class="button_row">
								<span class="button_group text_tools">
									<button type="button" class="icon heading-1" data-trix-attribute="heading1" title="Titel">Heading</button>
									<button type="button" class="icon bold" data-trix-attribute="bold" data-trix-key="b" title="Vetgedrukt">Bold</button>
									<button type="button" class="icon italic" data-trix-attribute="italic" data-trix-key="i" title="Cursief">Italic</button>
									{# <button type="button" class="icon strike" data-trix-attribute="strike" title="Doorstrepen">Strikethrough</button> #}
									<button type="button" class="icon link" data-trix-attribute="href" data-trix-action="link" data-trix-key="k" title="Link">Link</button>
								</span>

                <span class="button_group text_tools">
									{# <button type="button" class="icon quote" data-trix-attribute="quote" title="Quote">Quote</button>
									<button type="button" class="icon code" data-trix-attribute="code" title="Code">Code</button> #}
									<button type="button" class="icon list bullets" data-trix-attribute="bullet" title="Opsomming">Bullets</button>
									<button type="button" class="icon list numbers" data-trix-attribute="number" title="Genummerde lijst">Numbers</button>
									<button type="button" class="icon nesting-level decrease" data-trix-action="decreaseNestingLevel" title="Inspringen vergroten" disabled="">Decrease Level</button>
									<button type="button" class="icon nesting-level increase" data-trix-action="increaseNestingLevel" title="Inspringen verkleinen" disabled="">Increase Level</button>
								</span>

                {# <span class="button_group history_tools">
								<button type="button" class="icon undo" data-trix-action="undo" data-trix-key="z" title="Undo" disabled="">Undo</button>
								<button type="button" class="icon redo" data-trix-action="redo" data-trix-key="shift+z" title="Redo" disabled="">Redo</button>
								</span> #}
            </div>

            <div class="dialogs">
                <div class="dialog link_dialog" data-trix-attribute="href" data-trix-dialog="href">
                    <div class="link_url_fields">
                        <input type="url" required="" name="href" placeholder="Enter a URLâ€¦">
                        <div class="button_group">
                            <input type="button" value="Link" data-trix-method="setAttribute">
                            <input type="button" value="Unlink" data-trix-method="removeAttribute">
                        </div>
                    </div>
                </div>
            </div>
        </trix-toolbar>
        <trix-editor id="js-editor" class="userContentEditor" input="js-description" toolbar="trixToolbar"></trix-editor><br>
        <!--<textarea name="description"></textarea>-->


        <input class="idea-form-redirect-uri" type="hidden" name="redirect" value="{{data.widget.redirect}}" />
        <div id="charsLeftMain">Nog minimaal <span>140</span> tekens.</div><br/><br/>


        <input type="hidden" name="id" value="">
        <input type="hidden" name="_method" value="PUT">
        <input type="hidden" name="_csrf" value="">
    </div>

    <div id="location">
        <h2>Locatie</h2>
        <div class="form-info" style="height: auto;">Heeft jouw plan betrekking op een specifieke plek? Klik dan op de juiste locatie in de kaart om een vlaggetje te plaatsen. Verwijder het vlaggetje door hem nogmaals aan te klikken.</div>
<<<<<<< HEAD
        <input type="hidden" id="locationField" name="location" value='{{idea.location | dump | safe}}'>
        <!--<div id="mapcontainer">
=======
        <div id="mapcontainer">
>>>>>>> 1fa2277c9ecc1de12b03b3208c7f024bbb5f4865
            {% set editorInputElementId = 'locationField' %}
            {% include 'includes/openstad-map.html'  %}
        </div>-->
    </div>

    <div id="estimate">
        <h2>Inschatting kosten</h2>
        <div class="form-info" style="height: auto;">Geef een inschatting van wat jouw plan kost. Vind je dit moeilijk, dan kun je ook het <a href="mailto:duinoordbegroot@denhaag.nl">stadsdeel</a> vragen om je daarbij te helpen. Als andere organisaties willen meebetalen aan het plan, kun je dat ook hier aangeven.</div>
        <input type="text" id="estimate_input" name="estimate"
               {% if idea.extraData.estimate %}
               value="{{idea.extraData.estimate}}"
               {% endif %}
        >
    </div>

    <div id="role">
        <h2>Welke rol ga je zelf vervullen bij de uitvoering?</h2>
        <div class="form-info" style="height: auto;">Bewoners kunnen zelf of samen met de gemeente of een andere organisatie een plan uitvoeren. Geef aan welke rol je hierin wilt en kunt vervullen.</div>
        <textarea id="role_input" name="role"></textarea>
    </div>

    <div id="phone">
        <h2>Telefoonnummer (optioneel)</h2>
        <div class="form-info" style="height: auto;">Vul hier (optioneel) je telefoonnummer in, zodat we snel contact met je kunnen opnemen over je plan.</div>
        <input type="number" id="phone_input" name="phone" value="">
    </div>

    {% if idea.posterImage %}
    <input type="hidden" name="images[]" value="">
    {% endif %}

    <input type="submit" value="Plan opslaan">
</form>

{% endif %}

<script src="/dropzone/dist/dropzone.js"></script>
<script src="/trix/dist/trix.js"></script>
<script src="/js/editor.js"></script>

<script>
    // Idea form extensions
    // --------------------
    // Used by poster file upload and description editor to register
    // a reference to each uploaded file. This reference list is used
    // by the server to connect the correct image uploads to this idea.
    var form = document.getElementById('js-form');
    form.addAttachmentRef = function( key ) {
        var input   = document.createElement('input');
        input.type  = 'hidden';
        input.name  = 'images[]';
        input.value = key;
        this.appendChild(input);
    };
    form.clearAttachmentRef = function() {
        var images = Array.prototype.slice.call(
            form.querySelectorAll('input[name="images[]"]'), 0
        );
        images.forEach(function( image ) {
            this.removeChild(image);
        }, this);
    };
    form.addEventListener('submit', function( event ) {

        var uploadForm = document.getElementById('posterImageUpload');
        if( !uploadForm ) return;

        if( uploadForm.classList.contains('uploading') ) {
            event.stopPropagation();
            event.preventDefault();
            alert(
                'De afbeelding upload is nog niet afgerond.\n\n'+
                'Hierdoor kan uw idee nog niet opgeslagen worden.'
            );
        }

        // extra data
        var extraData = {
            thema: document.getElementById('thema').value,
            role: document.getElementById('role_input').value,
            estimate: document.getElementById('estimate_input').value,
            phone: document.getElementById('phone_input').value,
        }
        document.getElementById('extraData').value = JSON.stringify(extraData);

        console.log (extraData);

    });
</script>
<!--<script>
    var currentImage;
    var form        = document.getElementById('js-form');
    var el          = document.getElementById('posterImageUpload');
    var button      = el.querySelector('button');
    var progressBar = el.querySelector('#posterImageUpload .progress .bar');

    button.addEventListener('click', function() {
        upload.removeFile(currentImage || {});
    });

    var upload = new Dropzone(el, {
        maxFiles             : 1,
        uploadMultiple       : false,

        maxFilesize          : 10,
        maxThumbnailFilesize : 10,
        thumbnailWidth       : 1800,
        thumbnailHeight      : null,

        addedfile: function( file ) {
            this.removeFile(currentImage || {});
            currentImage = file;

            el.classList.add('uploading');
            progressBar.style.width = 0;

            file.key = Date.now()+'-'+file.name;
            this.options.params['key'] = file.key;
        },
        removedfile: function( file ) {
            el.removeAttribute('style');
            el.classList.remove('uploading');
            form.clearAttachmentRef();
        },

        thumbnail: function( file, dataURL ) {
            el.setAttribute('style', 'background-image: url('+dataURL+')');
        },
        sending: function() {
            button.innerHTML = 'Annuleer upload';
        },
        uploadprogress: function( file, progress, bytesSent ) {
            progressBar.style.width = progress+'%';
        },

        success: function( file ) {
            el.classList.remove('uploading');
            form.addAttachmentRef(file.key);
            button.innerHTML = 'Verwijder afbeelding';
        },
        error: function( file, error ) {
            button.innerHTML = 'Verwijder afbeelding';
            this.removeFile(file);
            if( typeof error != 'string' ) {
                alert(error.message);
            }
        }
    });
</script>-->
<script>
    // Summary
    // -------
    var maxLen    = {{summaryMaxLength}};
    var textarea  = document.querySelector('textarea[name="summary"]');
    var charsLeft = document.querySelector('#charsLeft span');

    updateCharsLeft();
    textarea.addEventListener('keydown', function( event ) {
        var len = textarea.value.length;
        var key = event.key.toLowerCase();

        // Prevent input when maximum is reached.
        if( len == maxLen ) {
            switch( key ) {
                case 'delete': case 'backspace':
                case 'arrowdown': case 'arrowup':
                case 'arrowleft': case 'arrowright':
                    return;
                default:
                    event.preventDefault();
            }
        }
    });
    textarea.addEventListener('keyup', updateCharsLeft);

    function updateCharsLeft() {
        charsLeft.innerHTML = maxLen - textarea.value.length;
        if (maxLen >= textarea.value.length) {
            charsLeft.style.color = '#9A9A9A';
        } else {
            charsLeft.style.color = 'red';
        }
    }
</script>

<script>


    // Main editor
    // -----------
    var minLen = 140;
    var charsLeftMain = document.querySelector('#charsLeftMain span');

    setTimeout(() => {

        {% if useModernEditor %}
        initAttachmentManager(
            document.getElementById('js-form'),
            document.getElementById('js-editor').editor
        );
        var mainEditor  = document.getElementById('js-editor');
        document.querySelector('#charsLeftMain').style.marginTop = '-20px';
        {% else %}
        var mainEditor  = document.getElementById('js-editor');
        {% endif %}
        mainEditor.addEventListener('keyup', updateCharsLeftMain);

        function updateCharsLeftMain() {
            {% if useModernEditor %}
            let length = minLen - mainEditor.innerHTML.length
            {% else %}
            let length = minLen - mainEditor.value.length
            {% endif %}
            if (length <= 0) {
                document.querySelector('#charsLeftMain').style.display = 'none';
            } else {
                document.querySelector('#charsLeftMain').style.display = 'block';
                document.querySelector('#charsLeftMain span').innerHTML = length;
            }
        }

        updateCharsLeftMain();

    } , 1000);

</script>

<script src="https://unpkg.com/filepond-polyfill/dist/filepond-polyfill.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-preview/dist/filepond-plugin-image-preview.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-type/dist/filepond-plugin-file-validate-type.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-validate-size/dist/filepond-plugin-file-validate-size.js"></script>
<script src="https://unpkg.com/filepond-plugin-file-poster/dist/filepond-plugin-file-poster.js"></script>
<script src="https://unpkg.com/filepond-plugin-image-exif-orientation/dist/filepond-plugin-image-exif-orientation.js"></script>
