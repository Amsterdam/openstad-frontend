{% set editorInputElementId = 'map' %}
<script src="https://maps.googleapis.com/maps/api/js?key={{apos.settings.getOption('googleMapsApiKey')}}"></script>
<script src="{{apos.settings.getOption('appUrl')}}/js/lib/map.js"></script>

<div id="{{editorInputElementId}}" style="width: 100%; height: 100%;"></div>

<script>

 var markers = [
	  {% for idea in data.widget.ideas %}
	  {% if (idea.location) and (idea.status !=  'DENIED' or ideas.length == 1) %}
	 {
		 position: JSON.parse('{{idea.location | dump | safe}}' || null),
		 icon     : {
			 url    : {% if ( idea.status == 'DONE' ) or (idea.status == 'ACCEPTED') or (idea.status == 'BUSY') %}'{{apos.settings.getOption('appUrl')}}/img/idea/flag-blue.svg'{% elseif ( idea.status == 'CLOSED' ) or (idea.status == 'DENIED') %}'{{apos.settings.getOption('appUrl')}}/img/idea/flag-gray.svg'{% else %}'{{apos.settings.getOption('appUrl')}}/img/idea/flag-red.svg'{% endif %},
			 size   : [22, 24],
			 anchor : [ 4, 21],
		 },
		 href: '/{{data.widget.ideaSlug}}/{{idea.id}}',
		 status: '{{idea.status}}',
		 endDate: '{{idea.endDate}}',
	 },
	  {% endif %}
	  {% endfor %}
 ]

 // delete old markers when there are too many
 let selectedMarkers = [];
 if (markers.length > 20) {
	 markers.forEach(function(marker) {
		 let select = true;
		 if (marker.status ==  'CLOSED') {
			 let datediff = new Date().getTime() - new Date(marker.endDate).getTime();
			 if ( datediff > 1000 * 60 * 60 * 24 * 90 ) {
				 select = false;
			 }
		 }
		 if (select) {
			 selectedMarkers.push(marker);
		 }
	 });
 } else {
	 selectedMarkers = markers
 }

 if ('{{editorInputElementId}}') {
	 var editorInputElement = document.getElementById('{{editorInputElementId}}');
	 var editorMarker = {
		 icon     : {
			 url    : '{{apos.settings.getOption('appUrl')}}/img/idea/flag-red.svg',
			 size   : [22, 24],
			 anchor : [ 4, 21],
		 }
	 }
 }

 var map = new OpenStadMap(
	 {% if config.openStadMap.markerStyle %}{{ config.openStadMap.markerStyle | dump | safe }}{% else %}null{% endif %},
	 {% if config.openStadMap.polygonStyle %}{{ config.openStadMap.polygonStyle | dump | safe }}{% else %}null{% endif %},
	 editorInputElement,
	 editorMarker
 );

 map.createMap(
   {% if apos.settings.getOption('openStadMap').defaults %}{{ apos.settings.getOption('openStadMap').defaults | dump | safe }}{% else %}null{% endif %},
   selectedMarkers,
   null
 )

</script>
